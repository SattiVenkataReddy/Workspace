<?xml version="1.0" encoding="UTF-8"?>
<bpmn2:definitions
  xmlns:bpmn2="http://www.omg.org/spec/BPMN/20100524/MODEL"
  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
  xmlns:drools="http://www.jboss.org/drools"
  xmlns:tns="http://www.jboss.org/drools"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  id="Defs_Telecom_SIM_Activation_Kogito"
  targetNamespace="http://example.com/telecom/bpmn">

  <!-- ItemDefinitions (referenced by properties) -->
  <bpmn2:itemDefinition id="_int"     structureRef="java.lang.Integer"/>
  <bpmn2:itemDefinition id="_bool"    structureRef="java.lang.Boolean"/>
  <bpmn2:itemDefinition id="_string"  structureRef="java.lang.String"/>

  <bpmn2:process id="Telecom_SIM_Activation_Mock" name="Telecom SIM Activation (Mocked)" isExecutable="true">
    <!-- Process variables (now correctly pointing to itemDefinitions) -->
    <bpmn2:property id="kycScore"            name="kycScore"            itemSubjectRef="_int"/>
    <bpmn2:property id="hasDebt"             name="hasDebt"             itemSubjectRef="_bool"/>
    <bpmn2:property id="emailVerified"       name="emailVerified"       itemSubjectRef="_bool"/>
    <bpmn2:property id="verificationPassed"  name="verificationPassed"  itemSubjectRef="_bool"/>
    <bpmn2:property id="simStatus"           name="simStatus"           itemSubjectRef="_string"/>
    <bpmn2:property id="activationTs"        name="activationTs"        itemSubjectRef="_string"/>
    <bpmn2:property id="failureMessage"      name="failureMessage"      itemSubjectRef="_string"/>

    <!-- Start -->
    <bpmn2:startEvent id="Start_SIM_Request" name="SIM Activation Request">
      <bpmn2:outgoing>Flow_1</bpmn2:outgoing>
    </bpmn2:startEvent>

    <!-- Script: Initialize defaults if not provided -->
    <bpmn2:scriptTask id="Task_Init" name="Init Mock Inputs" scriptFormat="http://www.java.com/java">
      <bpmn2:incoming>Flow_1</bpmn2:incoming>
      <bpmn2:outgoing>Flow_2</bpmn2:outgoing>
      <bpmn2:script><![CDATA[
        Object s = kcontext.getVariable("kycScore");
        if (s == null) kcontext.setVariable("kycScore", Integer.valueOf(680));

        Object d = kcontext.getVariable("hasDebt");
        if (d == null) kcontext.setVariable("hasDebt", Boolean.FALSE);

        Object e = kcontext.getVariable("emailVerified");
        if (e == null) kcontext.setVariable("emailVerified", Boolean.TRUE);
      ]]></bpmn2:script>
    </bpmn2:scriptTask>

    <!-- Script: Verify -->
    <bpmn2:scriptTask id="Task_Verify" name="Verify Customer (Mock Logic)" scriptFormat="http://www.java.com/java">
      <bpmn2:incoming>Flow_2</bpmn2:incoming>
      <bpmn2:outgoing>Flow_3</bpmn2:outgoing>
      <bpmn2:script><![CDATA[
        Integer score = (Integer) kcontext.getVariable("kycScore");
        Boolean debt   = (Boolean) kcontext.getVariable("hasDebt");
        Boolean email  = (Boolean) kcontext.getVariable("emailVerified");
        boolean passed = (score != null && score.intValue() >= 700)
                         && Boolean.TRUE.equals(email)
                         && Boolean.FALSE.equals(debt);
        kcontext.setVariable("verificationPassed", Boolean.valueOf(passed));
      ]]></bpmn2:script>
    </bpmn2:scriptTask>

    <!-- XOR -->
    <bpmn2:exclusiveGateway id="Gw_Verification" name="Verification Passed?" gatewayDirection="Diverging" default="Flow_No">
      <bpmn2:incoming>Flow_3</bpmn2:incoming>
      <bpmn2:outgoing>Flow_Yes</bpmn2:outgoing>
      <bpmn2:outgoing>Flow_No</bpmn2:outgoing>
    </bpmn2:exclusiveGateway>

    <!-- Script: Activate (mock) -->
    <bpmn2:scriptTask id="Task_Activate" name="Activate SIM (Mock)" scriptFormat="http://www.java.com/java">
      <bpmn2:incoming>Flow_Yes</bpmn2:incoming>
      <bpmn2:outgoing>Flow_4</bpmn2:outgoing>
      <bpmn2:script><![CDATA[
        kcontext.setVariable("simStatus", "ACTIVE");
        kcontext.setVariable("activationTs", java.time.OffsetDateTime.now().toString());
      ]]></bpmn2:script>
    </bpmn2:scriptTask>

    <!-- End: Success -->
    <bpmn2:endEvent id="End_Success" name="SIM Activated">
      <bpmn2:incoming>Flow_4</bpmn2:incoming>
    </bpmn2:endEvent>

    <!-- Script: Failure message -->
    <bpmn2:scriptTask id="Task_FailMsg" name="Compose Failure Notice (Mock)" scriptFormat="http://www.java.com/java">
      <bpmn2:incoming>Flow_No</bpmn2:incoming>
      <bpmn2:outgoing>Flow_5</bpmn2:outgoing>
      <bpmn2:script><![CDATA[
        kcontext.setVariable("simStatus", "FAILED");
        kcontext.setVariable("failureMessage",
          "Activation denied. Re-verify email, ensure KYC â‰¥ 700 and no outstanding debt.");
      ]]></bpmn2:script>
    </bpmn2:scriptTask>

    <!-- End: Failure -->
    <bpmn2:endEvent id="End_Failure" name="Activation Failed">
      <bpmn2:incoming>Flow_5</bpmn2:incoming>
    </bpmn2:endEvent>

    <!-- Flows -->
    <bpmn2:sequenceFlow id="Flow_1" sourceRef="Start_SIM_Request" targetRef="Task_Init"/>
    <bpmn2:sequenceFlow id="Flow_2" sourceRef="Task_Init" targetRef="Task_Verify"/>
    <bpmn2:sequenceFlow id="Flow_3" sourceRef="Task_Verify" targetRef="Gw_Verification"/>

    <bpmn2:sequenceFlow id="Flow_Yes" sourceRef="Gw_Verification" targetRef="Task_Activate">
      <bpmn2:conditionExpression xsi:type="bpmn2:tFormalExpression" language="http://www.java.com/java"><![CDATA[
        Boolean.TRUE.equals((Boolean) kcontext.getVariable("verificationPassed"))
      ]]></bpmn2:conditionExpression>
    </bpmn2:sequenceFlow>

    <bpmn2:sequenceFlow id="Flow_No" sourceRef="Gw_Verification" targetRef="Task_FailMsg">
      <bpmn2:conditionExpression xsi:type="bpmn2:tFormalExpression" language="http://www.java.com/java"><![CDATA[
        !Boolean.TRUE.equals((Boolean) kcontext.getVariable("verificationPassed"))
      ]]></bpmn2:conditionExpression>
    </bpmn2:sequenceFlow>

    <bpmn2:sequenceFlow id="Flow_4" sourceRef="Task_Activate" targetRef="End_Success"/>
    <bpmn2:sequenceFlow id="Flow_5" sourceRef="Task_FailMsg" targetRef="End_Failure"/>
  </bpmn2:process>

  <!-- DI: shapes + edges so the KIE VSCode plugin renders the diagram -->
  <bpmndi:BPMNDiagram id="Diag_1">
    <bpmndi:BPMNPlane id="Plane_1" bpmnElement="Telecom_SIM_Activation_Mock">
      <!-- Shapes -->
      <bpmndi:BPMNShape id="shape_start" bpmnElement="Start_SIM_Request">
        <dc:Bounds x="120" y="120" width="36" height="36"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="shape_init" bpmnElement="Task_Init">
        <dc:Bounds x="200" y="110" width="150" height="60"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="shape_verify" bpmnElement="Task_Verify">
        <dc:Bounds x="390" y="110" width="190" height="60"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="shape_gw" bpmnElement="Gw_Verification" isMarkerVisible="true">
        <dc:Bounds x="620" y="125" width="40" height="40"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="shape_activate" bpmnElement="Task_Activate">
        <dc:Bounds x="720" y="60" width="180" height="60"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="shape_end_success" bpmnElement="End_Success">
        <dc:Bounds x="940" y="70" width="36" height="36"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="shape_failmsg" bpmnElement="Task_FailMsg">
        <dc:Bounds x="720" y="180" width="220" height="60"/>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="shape_end_failure" bpmnElement="End_Failure">
        <dc:Bounds x="980" y="190" width="36" height="36"/>
      </bpmndi:BPMNShape>

      <!-- Edges -->
      <bpmndi:BPMNEdge id="edge_Flow_1" bpmnElement="Flow_1">
        <di:waypoint x="156" y="138"/>
        <di:waypoint x="200" y="140"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="edge_Flow_2" bpmnElement="Flow_2">
        <di:waypoint x="350" y="140"/>
        <di:waypoint x="390" y="140"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="edge_Flow_3" bpmnElement="Flow_3">
        <di:waypoint x="580" y="140"/>
        <di:waypoint x="620" y="145"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="edge_Flow_Yes" bpmnElement="Flow_Yes">
        <di:waypoint x="640" y="125"/>
        <di:waypoint x="640" y="90"/>
        <di:waypoint x="720" y="90"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="edge_Flow_4" bpmnElement="Flow_4">
        <di:waypoint x="900" y="90"/>
        <di:waypoint x="940" y="88"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="edge_Flow_No" bpmnElement="Flow_No">
        <di:waypoint x="640" y="165"/>
        <di:waypoint x="640" y="210"/>
        <di:waypoint x="720" y="210"/>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="edge_Flow_5" bpmnElement="Flow_5">
        <di:waypoint x="940" y="210"/>
        <di:waypoint x="980" y="208"/>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn2:definitions>